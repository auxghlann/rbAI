name: Deploy Backend to Heroku

on:
  push:
    branches: [ master ]
    paths:
      - 'rbai_server/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Install Heroku CLI
        run: curl https://cli-assets.heroku.com/install.sh | sh
      
      - name: Deploy to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          git config --global user.email "khestermesa@gmail.com"
          git config --global user.name "GitHub Actions"
          
          # Add Heroku remote
          heroku git:remote -a rbai-server
          
          # Deploy only the rbai_server subdirectory
          git subtree push --prefix rbai_server heroku master || \
          git push heroku `git subtree split --prefix rbai_server master`:refs/heads/master --force
